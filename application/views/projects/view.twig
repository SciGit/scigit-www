{% extends "base.twig" %}

{% block title project.name %}

{% block content %}

<script>
  var usernames = ['dsherk', 'ericho', 'hansonw', 'tammyt'];

  $(document).ready(function() {
    $("#btnEditDescription").click(function() {
      $("#description").hide();
      $("#editDescription").show();
    });

    $("#permissions .btn").click(function() {
      $("#permissions .span4").each(function() {
        $(this).addClass("faded");
      })

      $(this).html('<i class="icon-ok"></i> Selected')
      $(this).removeClass("btn-primary")
             .addClass("btn-success")
             .parent().removeClass("faded");
    })

    $('#user-invite form input').typeahead(
      {source: usernames}
    );

    function validateUser(field) {
      $("#email-invite").addClass("faded");
      $("#user-invite").removeClass("faded");

      if (usernames.indexOf(field.value) > -1) {
        $("#user-invite form i").attr("class", "icon-ok-sign")
                                .css("color", "green");
      } else {
        $("#user-invite form i").attr("class", "icon-remove-sign")
                                .css("color", "red");
      }
    }

    $('#user-invite form input').live('change', function() {
      validateUser(this);
    });
    $('#user-invite form input').live('change keypress', function() {
      validateUser(this);
    });

    function validateEmail(field) {
      $("#user-invite").addClass("faded");
      $("#email-invite").removeClass("faded");

      var re = /\S+@\S+\.\S+/;
      if (re.test(field.value)) {
        $("#email-invite form i").attr("class", "icon-ok-sign")
                                 .css("color", "green");
      } else {
        $("#email-invite form i").attr("class", "icon-remove-sign")
                                 .css("color", "red");
      }
    }

    $('#email-invite form input').live('change', function() {
      validateEmail(this);
    });
    $('#email-invite form input').live('change keypress', function() {
      validateEmail(this);
    });
  })
</script>

<div id="addMember" class="modal modal-large hide fade">
  <div class="modal-header">
    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
    <h1>Add Member</h1>
  </div>
  <div class="modal-body">
    <h3>Step 1: Permissions</h3>
    <h6>What permissions do you want to give this person?</h6>
    <p></p>
    <div class="well">
      <div id="permissions" class="row-fluid">
        <div class="span4 center">
          <h3>Administrator</h3>
          <p></p>
          <p>This user can edit the project and its settings, and add more contributors, or remove them.</p>
          <p></p>
          <a href="#" class="btn btn-large btn-primary">Select</a>
        </div>
        <div class="span4 center">
          <h3>Contributor</h3>
          <p></p>
          <p>This user can make changes to the contents of the project, but can't change settings or users.</p>
          <p></p>
          <a href="#" class="btn btn-large btn-primary">Select</a>
        </div>
        <div class="span4 center">
          <h3>Subscriber</h3>
          <p></p>
          <p>This user can only track changes to this project. Use this to invite people to watch your project.</p>
          <p></p>
          <a href="#" class="btn btn-large btn-primary">Select</a>
        </div>
      </div>
    </div>
    <h3>Step 2: Username or Email</h3>
    <h6>Who do you want to add to the project as a contributor?</h6>
    <p></p>
    <div class="row-fluid">
      <div id="user-invite" class="span6 center well">
        <h3>Find User</h3>
        <p></p>
        <p>Does the contributor you want to add already have a SciGit account? Search for them here.</p>
        <br />
        <p>Enter a username.</p>
        {{ form_open("/projects/invite/#{project.id}") | raw }}
          {{ form_input({class: 'full-width-input', placeholder: 'Username', name: 'invite', maxlength: 40}) | raw }}
          <i class="hide"></i>
        {{ form_close() | raw }}
      </div>
      <div id="email-invite" class="span6 center well">
        <h3>Invite to SciGit</h3>
        <p></p>
        <p>Invite someone to SciGit! Once they've joined, they'll be added to your project.</p>
        <br />
        <p>Enter an email.</p>
        {{ form_open("/users/invite/#{project.id}") | raw }}
          {{ form_input({class: 'full-width-input', placeholder: 'Email Address', name: 'invite', maxlength: 40}) | raw }}
          <i class="hide"></i>
        {{ form_close() | raw }}
      </div>
    </div>
  </div>
  <div class="modal-footer">
    <a href="#" class="btn btn-primary">Add Member</a>
    <a class="btn" data-dismiss="modal">Cancel</a>
  </div>
</div>

<p class="breadcrumbs">
  {{ anchor("/", "Home") | raw }} <span class="divider">&gt;</span>
  {% if member or admin %}
    {{ anchor("/projects", "My Projects") | raw }} <span class="divider">&gt;</span>
  {% else %}
    {{ anchor("/projects/explore", "Public") | raw }} <span class="divider">&gt;</span>
  {% endif %}
  <span class="current">{{ anchor("/projects/view/#{project.id}", project.name) | raw }}</span>
</p>

<div class="separator-xsmall"></div>

<div class="page-header">
  <h1>
    <div class="pull-right">
      {% if admin %}
        <a class="btn btn-large btn-primary" href="{{ site_url("/projects/admin/#{project.id}") | raw }}">
          <i class="icon-wrench icon-white"></i>
          Settings
        </a>
      {% elseif not member %}
        {{ form_open("/projects/subscribe/#{project.id}") | raw }}
          {{ form_input({class: 'hidden', name: 'return_to', value: 'view'}) | raw }}
          {{ form_submit({class: subscribed ? 'btn btn-large btn-danger' : 'btn btn-large btn-success', name: 'subscribe'},
              subscribed ? 'Unsubscribe' : 'Subscribe') | raw }}
        {{ form_close() | raw }}
      {% endif %}
    </div>
    {{ project.name }}
  </h1>
</div>

<div class="row-fluid">
  <div class="span4">
    <div class="blue-well-list">
      <table class="table table-condensed">
        <tr>
          <th>
            <h2>
              {% if admin %}
                <div class="pull-right">
                  <a id="btnEditDescription" class="btn btn-valign center" href="#" rel="tooltip" title="Edit description">
                    <i class="icon-large icon-edit"></i> Edit
                  </a>
                </div>
              {% endif %}
              Description
            </h2>
          </th>
        </tr>
        <tr class="nohover">
          <td class="tabular" valign="middle">
            <p id="description">
              {% if project.description %}
                {{ word_wrap(project.description, 30) }}
              {% else %}
                <p>This project has no description.</p>
              {% endif %}
            </p>
            {{ form_open("/projects/admin/#{project.id}", {id: "editDescription", class: "hide"}) | raw }}
              {{ form_textarea({class: "full-width-input", name: "description", value: project.description}) | raw }}
              <a href="#" onclick="$('#editDescription').submit();" class="btn btn-primary pull-right">Save</a>
            {{ form_close() | raw }}
          </td>
        </tr>
      </table>
    </div>
    <div class="well-list">
      <table class="table table-condensed">
        <tr>
          <th>
            <h2>
              Members
              {% if admin %}
                <div class="pull-right">
                  <a href="#addMember" rel="tooltip" title="Add new member" class="btn btn-valign" data-toggle="modal">
                    <i class="icon-plus"></i> Add
                  </a>
                </div>
              {% endif %}
            </h2>
          </th>
        </tr>
        {% for perm in perms %}
          <tr>
            <td class="tabular" valign="middle">
              {{ anchor("/users/profile/#{perm.user_id}", perm.username) | raw }}
              <div class="buttons">
                <div class="button">
                  {% if perm.permission b-and 8 %}
                    <i class="icon-wrench"></i>
                  {% else %}
                    <i class="icon-edit"></i>
                  {% endif %}
                </div>
              </div>
            </td>
          </tr>
        {% endfor %}
      </table>
    </div>
    <div class="well-list">
      <table class="table table-condensed">
        <tr>
          <th colspan="2">
            <h2>Stats</h2>
          </th>
        </tr>
        <tr class="nohover">
          <td>
            <div class="row-fluid stats">
              <div class="span6">
                <h4>{{ subscribers }}</h4>
                <p>Subscribers</p>
              </div>
              <div class="span6">
                <h4>{{ changes_num }}</h4>
                <p>Updates</p>
              </div>
            </div>
            <div class="row-fluid stats">
              <div class="span6">
                <h4>{{ contributors }}</h4>
                <p>Contributors</p>
              </div>
              <div class="span6">
                <h4>{{ administrators }}</h4>
                <p>Administrators</p>
              </div>
            </div>
            <div class="row-fluid stats">
              <div class="span12">
                <h3>{{ project.created_ts | date("Y-m-d") }}</h3>
                <p>Created</p>
              </div>
            </div>
          </td>
        </tr>
      </table>
    </div>
  </div>
  <div class="span8">
    {% include 'projects/changes_list.twig' %}
  </div>
</div>

{% endblock %}
