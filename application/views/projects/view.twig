{% extends "base.twig" %}

{% block title project.name %}

{% block content %}

<script>
$(document).ready(function() {
  $("#btnEditDescription").click(function() {
    $("#description").hide();
    $("#btnEditDescription").hide();
    $("#editDescription").show();
  });

  $("#editDescription").submit(function(e) {
    e.preventDefault();

    $('#editDescription a[name="submit"]').attr("class", "btn faded");
    $('#editDescription a[name="submit"]').html('<i class="icon-spinner icon-spin"></i> Loading...');

    var description = $('#editDescription textarea[name="description"]').val();

    $.ajax({
      url: '/projects/edit_description_ajax',
      type: 'post',
      data: {proj_id: {{ project.id }}, description: description},
      dataType: 'json',
      success: function(json) {
        $('#editDescription a[name="submit"]').attr("class", "btn btn-primary");
        $('#editDescription a[name="submit"]').html("Save");

        if (json.error == 0) {
          $("#description").text(description).show();
          $("#btnEditDescription").show();
          $("#editDescription").hide();

          $("#projectSuccess").html(json.message).show();
          $("#projectMessagePost").show();
        }
      }
    });
  });
});
</script>

<div id="projectError" class="alert alert-error hide"></div>
<div id="projectSuccess" class="alert alert-success hide"></div>
<div id="projectMessagePost" class="separator-small hide"></div>

<p class="breadcrumbs">
  {{ anchor("/", "Home") | raw }} <span class="divider">&gt;</span>
  {% if member or admin %}
    {{ anchor("/projects", "My Projects") | raw }} <span class="divider">&gt;</span>
  {% else %}
    {{ anchor("/projects/explore", "Public") | raw }} <span class="divider">&gt;</span>
  {% endif %}
  <span class="current">{{ anchor("/projects/view/#{project.id}", project.name) | raw }}</span>
</p>

<div class="separator-xsmall"></div>

<div class="page-header">
  <h1>
    <div class="pull-right">
      {% if admin %}
        <a class="btn btn-large btn-primary" href="{{ site_url("/projects/admin/#{project.id}") | raw }}">
          <i class="icon-wrench icon-white"></i>
          Settings
        </a>
      {% elseif not member %}
        {{ form_open("/projects/subscribe/#{project.id}") | raw }}
          {{ form_input({class: 'hidden', name: 'return_to', value: 'view'}) | raw }}
          {{ form_submit({class: subscribed ? 'btn btn-large btn-danger' : 'btn btn-large btn-success', name: 'subscribe'},
              subscribed ? 'Unsubscribe' : 'Subscribe') | raw }}
        {{ form_close() | raw }}
      {% endif %}
    </div>
    {{ project.name }}
  </h1>
</div>

<div class="row-fluid">
  <div class="span4">
    <div class="blue-well-list">
      <table class="table table-condensed">
        <tr>
          <th>
            <h2>
              {% if admin %}
                <div class="pull-right">
                  <a id="btnEditDescription" class="btn btn-primary btn-valign center" href="#" rel="tooltip" title="Edit description">
                    <i class="icon-large icon-edit"></i> Edit
                  </a>
                </div>
              {% endif %}
              Description
            </h2>
          </th>
        </tr>
        <tr>
          <td class="tabular" valign="middle">
            <p id="description">
              {% if project.description %}
                {{ word_wrap(project.description, 30) }}
              {% else %}
                This project has no description.
              {% endif %}
            </p>
            {{ form_open("/projects/edit_description_ajax", {id: "editDescription", class: "hide"}) | raw }}
              {{ form_textarea({class: "full-width-input", name: "description", value: project.description}) | raw }}
              {{ form_input({class: "hidden", name: "proj_id", value: project.id}) | raw }}
              <a href="#" name="submit" onclick="$('#editDescription').submit();" class="btn btn-primary pull-right">Save</a>
            {{ form_close() | raw }}
          </td>
        </tr>
      </table>
    </div>
    {% include 'projects/members.twig' with {project: project, perms: perms, admin: admin} %}
    <div class="well-list">
      <table class="table table-condensed">
        <tr>
          <th colspan="2">
            <h2>Stats</h2>
          </th>
        </tr>
        <tr>
          <td class="stats">
            <div class="row-fluid">
              <div class="span4">
                <h3>{{ subscribers }}</h3>
                <p>Subscribers</p>
              </div>
              <div class="span4">
                <h3>{{ administrators }}</h3>
                <p>Administrators</p>
              </div>
              <div class="span4">
                <h3>{{ contributors }}</h3>
                <p>Members</p>
              </div>
            </div>
            <div class="row-fluid">
              <div class="span4">
                <h3>{{ changes_num }}</h3>
                <p>Updates</p>
              </div>
              <div class="span8">
                <h3>{{ project.created_ts | date("Y-m-d") }}</h3>
                <p>Created</p>
              </div>
            </div>
          </td>
        </tr>
      </table>
    </div>
  </div>
  <div class="span8">
    {% include 'projects/changes_list.twig' %}
  </div>
</div>

{% endblock %}
